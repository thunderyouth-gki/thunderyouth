<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>History | Thunder Youth</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <style>
     * {
          box-sizing: border-box;
        }
  body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #f9f9f9;
      min-height: 120vh;
      overflow-x: hidden;
    }

    .header {
      position: sticky;
      width: 100%;
      height: 30px; /* Ensures a consistent height */
      padding-top: 10px;
      padding-bottom: 10px;
      padding-left: 20px;
      background-color: #f8f8f8;
      display: flex;
      align-items: center;
      overflow-x: hidden;
    }
    .header img {
      height: 25px;
    }
    .footer {
      display: flex;
      justify-content: space-around;
      align-items: center;
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: #f8f8f8;
      padding: 5px 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      border-radius: 20px 20px 0 0;
      transition: transform 0.3s ease-in-out;
      z-index: 1000;
    }

    .footer-item {
      text-align: center;
      cursor: pointer;
    }

    .footer-item img {
      width: 30px;
      height: 30px;
      margin-top: 5px;
    }

    .footer-item span {
      display: block;
      font-size: 12px;
      margin-top: 0px;
    }

    .footer.hide {
      transform: translateY(100%);
    }

    .footer.show {
      transform: translateY(0);
    }

    a {
      text-decoration: none; /* Remove underline */
      color: inherit; /* Keep the default text color */
    }

    a span {
      color: inherit; /* Ensure the text color doesn't change */
    }

    .history-title{
      text-align: left;
      font-size: 6vw;
      font-weight: bold;
      margin-bottom: 20px;
      color: #4D0FB1;
      padding-left: 20px;
    }

    .history-container {
      width: 90%;
      padding: 12px;
      margin: 20px;
      border-radius: 15px;
      box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
      color: black;
      display: flex;
      justify-content: space-between;
      align-items: center;    
    }

    .attended { background-color: #FFDA56; }
    .absent { background-color: #9E9E9E; color: white;}
    .info { flex-grow: 1; }
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 50px;
      background-color: #4D0FB1;
      color: #F8F8F8;
      cursor: pointer;
    }
    button[disabled] {
      background-color: #ccc;
      color: #666;
      cursor: not-allowed;
    }

    #loadingOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: #DBCFEF;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #loadingOverlay img {
      width: 100px;
      height: auto;
    }

    #loadingText {
      margin-top: 16px;
      font-family: 'Poppins', sans-serif;
      color: #4D0FB1;
      font-size: 12px;
      text-align: center;
      padding: 0 20px;
      text-wrap: balance;
    }


    </style>
  </head>
  <body>
  <div class="header">
    <img src="https://lh3.googleusercontent.com/d/1VikC7CxegmubJZ1paeu4NXSS8W9Dgpf2" alt="Logo">
  </div>

  <div id=loadingOverlay>
    <img src="https://github.com/thunderyouth-gki/thunderyouth/blob/main/sailing%20cross.gif?raw=true" alt="Loading..." style="width: 100px;">
  <div id="loadingText"></div>
</div>
    
    <div class="history-title">Event History</div>

    <div class="footer" id="footer">
    <div class="footer-item" onclick="toggleIcon(this)">
      <a href='https://thunderyouth.gkiguntur.com/'>
      <img src="https://lh3.googleusercontent.com/d/1M1axLb9BnoWun9iDPcAx_ZUID5ZlEl_m" 
           data-default="https://lh3.googleusercontent.com/d/1M1axLb9BnoWun9iDPcAx_ZUID5ZlEl_m" 
           data-active="https://lh3.googleusercontent.com/d/1Ls9Ci-xvgXQZePWs-33468b0EUQz0pxd" 
           alt="Home">
      <span>Home</span>
      </a>
    </div>
    <div class="footer-item" onclick="toggleIcon(this)">
      <a href='https://thunderyouth.gkiguntur.com/warta'>
      <img src="https://lh3.googleusercontent.com/d/1WMPNZl0Lc724pDDoC4lsWQtbkP3h6yUD" 
           data-default="https://lh3.googleusercontent.com/d/1WMPNZl0Lc724pDDoC4lsWQtbkP3h6yUD" 
           data-active="https://lh3.googleusercontent.com/d/1WIGRe_Ba07hCyw5N1fetmm7i5yjHx8S9" 
           alt="History">
      <span>Warta</span>
      </a>
    </div>
    <div class="footer-item">
      <img src="https://lh3.googleusercontent.com/d/1LydGXt7w6IyiRWfP7Hdi8YfpBWBqxdHp" 
           data-default="https://lh3.googleusercontent.com/d/1MF2aumWkfIvGKqsg_P84G2iv8agK5nyy" 
           data-active="https://lh3.googleusercontent.com/d/1LydGXt7w6IyiRWfP7Hdi8YfpBWBqxdHp" 
           alt="History">
      <span>History</span>
    </div>
    <div class="footer-item" onclick="toggleIcon(this)">
      <a href='https://thunderyouth.gkiguntur.com/profile'>
      <img src="https://lh3.googleusercontent.com/d/1M8uxpiXhKUmu2WMR6_iR1RraErskHuZ9" 
           data-default="https://lh3.googleusercontent.com/d/1M8uxpiXhKUmu2WMR6_iR1RraErskHuZ9" 
           data-active="https://lh3.googleusercontent.com/d/1Lt3K_ZqPYJUT2iv1mLyTBpvtuMuhxWOA" 
           alt="Profile">
      <span>Profile</span>
      </a>
    </div>
  </div>

    <script>

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    const API_BASE = "https://script.google.com/macros/s/AKfycbwMZAEMfeT-GIZgcvOWi8Kw0kpo7OZEpBb-gPHhXvDDtYfFqeyzuCDRdS2-PUReZzO0/exec";

    function toggleIcon(selectedElement) {
      document.querySelectorAll('.footer-item').forEach(item => {
        item.classList.remove('active');
        const img = item.querySelector('img');
        img.src = img.dataset.default;
      });

      selectedElement.classList.add('active');
      const selectedImg = selectedElement.querySelector('img');
      selectedImg.src = selectedImg.dataset.active;
    }

    let lastScrollTop = 0;
    const footer = document.getElementById("footer");

    window.addEventListener("scroll", function () {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      if (scrollTop > lastScrollTop) {
        footer.classList.remove("show");
        footer.classList.add("hide");
      } else {
        footer.classList.remove("hide");
        footer.classList.add("show");
      }
      lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
    });

    function fetchHistory(email) {
      fetch(`${API_BASE}?page=History&email=${encodeURIComponent(email)}`)
        .then(response => response.json())
        .then(data => renderHistory(data))
        .catch(err => console.error("Fetch error:", err));
    }

    function renderHistory(history) {
      const container = document.querySelector("body");
      const title = document.querySelector(".history-title");

      if (!history || history.length === 0) {
        const p = document.createElement("p");
        p.textContent = "No history found.";
        container.insertBefore(p, title.nextSibling);
        return;
      }

      history.forEach((item, i) => {
        const div = document.createElement("div");
        div.className = `history-container ${item.attendance ? "attended" : "absent"}`;

        const info = document.createElement("div");
        info.className = "info";
        info.innerHTML = `<strong>${item.eventName}</strong><br><span>${item.date}</span>`;

        const buttonContainer = document.createElement("div");
        if (item.eventName !== "Sunday Service") {
          const button = document.createElement("button");
          button.id = `btn_${i}`;
          button.textContent = item.requestEvent ? "Requested" : "Request Event";
          button.disabled = item.requestEvent;
          button.onclick = () => handleRequestEvent(item.eventName, item.date, button.id);
          buttonContainer.appendChild(button);
        }

        div.appendChild(info);
        div.appendChild(buttonContainer);
        container.insertBefore(div, document.getElementById("footer"));
      });
    }

function handleRequestEvent(eventName, date, buttonId) {
  const btn = document.getElementById(buttonId);
  const email = localStorage.getItem("email");

  const url = `${API_BASE}?page=RequestEvent&eventName=${encodeURIComponent(eventName)}&date=${encodeURIComponent(date)}&email=${encodeURIComponent(email)}`;

  fetch(url)
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        btn.textContent = "Requested";
        btn.disabled = true;
      } else {
        alert("Failed to submit request.");
        console.error(result);
      }
    })
    .catch(error => {
      console.error("Fetch error:", error);
      alert("Error sending request: " + error.message);
    });
}

window.addEventListener("DOMContentLoaded", async function () {
  const wittyQuotes = [
    "Lagi loading... sabar ya kak, berkat Tuhan juga kadang turun pelan-pelan ☁️✨",
    "Tenang, semua yang baik datang pada waktunya… termasuk halaman ini 🙌",
    "Lagi diproses kak, kayak Tuhan lagi proses hati kita 😌✨",
    "Mohon bersabar, ini bukan sekadar loading… ini latihan iman 💡"
  ];
  document.getElementById("loadingText").textContent =
    wittyQuotes[Math.floor(Math.random() * wittyQuotes.length)];

  const savedEmail = localStorage.getItem("email");

  if (!savedEmail) {
    // No saved email — redirect to login
    window.location.href = "https://thunderyouth.gkiguntur.com/login?redirect=history";
    return;
  }

  // Proceed if email exists
  await Promise.all([
    fetch(`${API_BASE}?page=History&email=${encodeURIComponent(savedEmail)}`)
      .then(response => response.json())
      .then(data => renderHistory(data))
      .catch(err => console.error("Fetch error:", err)),
    delay(2000)
  ]);

  // Hide loading
  const overlay = document.getElementById("loadingOverlay");
  if (overlay) overlay.style.display = "none";
});

    </script>
  </body>
</html>
